{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/adlan/multas/multas/lib/db.ts"],"sourcesContent":["import { Pool } from \"pg\";\r\n\r\nconst pool = new Pool({\r\n  connectionString: process.env.DATABASE_URL,\r\n});\r\n\r\nexport async function query(text: string, params?: any[]) {\r\n  return pool.query(text, params);\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;;;;;;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;AAC5C;AAEO,eAAe,MAAM,IAAY,EAAE,MAAc;IACtD,OAAO,KAAK,KAAK,CAAC,MAAM;AAC1B"}},
    {"offset": {"line": 105, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/adlan/multas/multas/app/api/auth/login-asesor/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\nimport { query } from \"@/lib/db\";\r\nimport bcrypt from \"bcryptjs\";\r\nimport jwt from \"jsonwebtoken\";\r\n\r\nexport async function POST(req: Request) {\r\n  try {\r\n    const { username, password } = await req.json();\r\n\r\n    if (!username || !password) {\r\n      return NextResponse.json(\r\n        { message: \"Usuario y contraseña son requeridos\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Traemos role (nombre de columna: role)\r\n    const result = await query(\r\n      \"SELECT id, username, password, role FROM users WHERE username = $1\",\r\n      [username]\r\n    );\r\n\r\n    if (result.rowCount === 0) {\r\n      return NextResponse.json(\r\n        { message: \"Credenciales incorrectas\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    const user = result.rows[0];\r\n\r\n    // Comprobar role usando user.role (no user.rol)\r\n    if (user.role !== \"asesor\") {\r\n      return NextResponse.json(\r\n        { message: \"No tienes permisos de asesor\" },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    const valid = await bcrypt.compare(password, user.password);\r\n\r\n    if (!valid) {\r\n      return NextResponse.json(\r\n        { message: \"Contraseña incorrecta\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    const token = jwt.sign(\r\n      { id: user.id, role: user.role, username: user.username },\r\n      process.env.JWT_SECRET!,\r\n      { expiresIn: \"1d\" }\r\n    );\r\n\r\n    const response = NextResponse.json({ success: true });\r\n\r\n    response.cookies.set(\"token\", token, {\r\n      httpOnly: true,\r\n      secure: process.env.NODE_ENV === \"production\", // true en prod, false en dev\r\n      sameSite: \"lax\", // 'lax' facilita pruebas locales; cámbialo a 'strict' en prod si quieres\r\n      path: \"/\",\r\n      maxAge: 60 * 60 * 24,\r\n    });\r\n\r\n    return response;\r\n  } catch (error: any) {\r\n    console.log(\"ERROR login-asesor:\", error);\r\n    return NextResponse.json(\r\n      { message: \"Error en el servidor\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;;;;;;;;;AAEO,eAAe,KAAK,GAAY;IACrC,IAAI;QACF,MAAM,EAAE,QAAQ,EAAE,QAAQ,EAAE,GAAG,MAAM,IAAI,IAAI;QAE7C,IAAI,CAAC,YAAY,CAAC,UAAU;YAC1B,OAAO,oKAAY,CAAC,IAAI,CACtB;gBAAE,SAAS;YAAsC,GACjD;gBAAE,QAAQ;YAAI;QAElB;QAEA,yCAAyC;QACzC,MAAM,SAAS,MAAM,IAAA,wIAAK,EACxB,sEACA;YAAC;SAAS;QAGZ,IAAI,OAAO,QAAQ,KAAK,GAAG;YACzB,OAAO,oKAAY,CAAC,IAAI,CACtB;gBAAE,SAAS;YAA2B,GACtC;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,OAAO,OAAO,IAAI,CAAC,EAAE;QAE3B,gDAAgD;QAChD,IAAI,KAAK,IAAI,KAAK,UAAU;YAC1B,OAAO,oKAAY,CAAC,IAAI,CACtB;gBAAE,SAAS;YAA+B,GAC1C;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,QAAQ,MAAM,kKAAM,CAAC,OAAO,CAAC,UAAU,KAAK,QAAQ;QAE1D,IAAI,CAAC,OAAO;YACV,OAAO,oKAAY,CAAC,IAAI,CACtB;gBAAE,SAAS;YAAwB,GACnC;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,QAAQ,sKAAG,CAAC,IAAI,CACpB;YAAE,IAAI,KAAK,EAAE;YAAE,MAAM,KAAK,IAAI;YAAE,UAAU,KAAK,QAAQ;QAAC,GACxD,QAAQ,GAAG,CAAC,UAAU,EACtB;YAAE,WAAW;QAAK;QAGpB,MAAM,WAAW,oKAAY,CAAC,IAAI,CAAC;YAAE,SAAS;QAAK;QAEnD,SAAS,OAAO,CAAC,GAAG,CAAC,SAAS,OAAO;YACnC,UAAU;YACV,QAAQ,oDAAyB;YACjC,UAAU;YACV,MAAM;YACN,QAAQ,KAAK,KAAK;QACpB;QAEA,OAAO;IACT,EAAE,OAAO,OAAY;QACnB,QAAQ,GAAG,CAAC,uBAAuB;QACnC,OAAO,oKAAY,CAAC,IAAI,CACtB;YAAE,SAAS;QAAuB,GAClC;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}